<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WoofWorks Dashboard</title>
  <style>
    :root {
      --bg-dark: #0a0f0a;
      --bg-panel: #111c11;
      --green-glow: #00ff99;
      --green-muted: #00cc88;
      --text-light: #caffdd;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-light);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background-color: var(--bg-panel);
      color: var(--green-glow);
      padding: 1rem;
      font-size: 1.8rem;
      font-weight: bold;
    }
    #login-section, #dashboard {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    input, button, textarea {
      padding: 0.7rem;
      margin: 0.5rem 0;
      border-radius: 8px;
      border: none;
      width: 100%;
      max-width: 400px;
      font-size: 1rem;
    }
    input, textarea {
      background-color: var(--bg-panel);
      color: var(--text-light);
    }
    button {
      background-color: var(--green-muted);
      color: #000;
      cursor: pointer;
    }
    .info-panel, #chat, #admin-panel {
      background-color: var(--bg-panel);
      border: 1px solid var(--green-muted);
      border-radius: 10px;
      padding: 1rem;
      margin: 1rem 0;
      width: 90%;
      max-width: 800px;
      box-shadow: 0 0 10px var(--green-muted);
    }
    .message-bubble {
      margin: 0.3rem 0;
      padding: 0.5rem;
      border-radius: 10px;
      display: inline-block;
      max-width: 75%;
      word-wrap: break-word;
    }
    .message-bubble.user-0 { background-color: #1f4032; }
    .message-bubble.user-1 { background-color: #2e593f; }
    .message-bubble.user-2 { background-color: #3a7c57; }
    .message-bubble.user-3 { background-color: #49986d; }
    #chat-input {
      display: flex;
    }
    #chat-input textarea {
      flex: 1;
    }
    #admin-tab {
      display: none;
    }
  </style>
</head>
<body>
  <header>WoofWorks Dashboard</header>

  <section id="login-section">
    <h2>Login</h2>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button id="login-btn">Login</button>
    <p id="login-error" style="color:#ff7b7b;"></p>
  </section>

  <section id="dashboard" style="display:none;">
    <div class="info-panel">
      <h2>Your Info</h2>
      <p>WoofCoin: <span id="woofcoin">...</span></p>
      <p>Rank: <span id="rank">...</span></p>
      <p>Role: <span id="role">...</span></p>
      <p>Admin: <span id="is-admin">...</span></p>
    </div>

    <div class="info-panel">
      <h2>Public Tasks</h2>
      <ul id="tasks-list"></ul>
    </div>

    <div id="chat" class="info-panel">
      <h2>Chat</h2>
      <div id="messages"></div>
      <div id="chat-input">
        <textarea id="message-input" rows="2" placeholder="Message..."></textarea>
        <button id="send-btn">Send</button>
      </div>
    </div>

    <div id="admin-tab" class="info-panel">
      <h2>Admin Panel</h2>
      <div id="admin-users">Loading users...</div>
    </div>

    <button id="logout-btn">Logout</button>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDsFimFgQKXLhpflX4PTfWcpKwfI5qM8I4",
      authDomain: "woofworks-dashboard.firebaseapp.com",
      projectId: "woofworks-dashboard",
      storageBucket: "woofworks-dashboard.firebasestorage.app",
      messagingSenderId: "150822066679",
      appId: "1:150822066679:web:4b5927a5389d90daa036f2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginSection = document.getElementById("login-section");
    const dashboard = document.getElementById("dashboard");
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const email = document.getElementById("email");
    const password = document.getElementById("password");
    const error = document.getElementById("login-error");
    const tasksList = document.getElementById("tasks-list");
    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const adminTab = document.getElementById("admin-tab");
    const adminUsers = document.getElementById("admin-users");

    const woofcoinSpan = document.getElementById("woofcoin");
    const rankSpan = document.getElementById("rank");
    const roleSpan = document.getElementById("role");
    const isAdminSpan = document.getElementById("is-admin");

    loginBtn.onclick = async () => {
      try {
        const userCred = await signInWithEmailAndPassword(auth, email.value, password.value);
        const uid = userCred.user.uid;
        const userRef = doc(db, "users", uid);
        const snap = await getDoc(userRef);
        if (!snap.exists()) {
          await setDoc(userRef, {
            woofcoin: 100,
            rank: "Intern",
            role: "Newbie",
            isAdmin: false,
            name: email.value.split("@")[0]
          });
        }
      } catch (e) {
        error.textContent = e.message;
      }
    };

    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        loginSection.style.display = "none";
        dashboard.style.display = "block";

        const uid = user.uid;
        const userRef = doc(db, "users", uid);
        const snap = await getDoc(userRef);
        const data = snap.data();

        woofcoinSpan.textContent = data.woofcoin;
        rankSpan.textContent = data.rank;
        roleSpan.textContent = data.role;
        isAdminSpan.textContent = data.isAdmin;

        if (data.isAdmin) {
          adminTab.style.display = "block";
          const userCol = await getDocs(collection(db, "users"));
          adminUsers.innerHTML = "";
          userCol.forEach(docu => {
            const d = docu.data();
            const div = document.createElement("div");
            div.innerHTML = `
              <p><strong>${d.name}</strong></p>
              <label>WoofCoin: <input value="${d.woofcoin}" data-uid="${docu.id}" data-field="woofcoin"></label>
              <label>Rank: <input value="${d.rank}" data-uid="${docu.id}" data-field="rank"></label>
              <label>Role: <input value="${d.role}" data-uid="${docu.id}" data-field="role"></label>
              <hr>
            `;
            adminUsers.appendChild(div);
          });

          adminUsers.addEventListener("change", async (e) => {
            const target = e.target;
            const uid = target.dataset.uid;
            const field = target.dataset.field;
            const value = field === "woofcoin" ? parseInt(target.value) : target.value;
            const ref = doc(db, "users", uid);
            await setDoc(ref, { [field]: value }, { merge: true });
          });
        }

        onSnapshot(collection(db, "tasks"), (snap) => {
          tasksList.innerHTML = "";
          snap.forEach(doc => {
            const li = document.createElement("li");
            li.textContent = doc.data().title;
            tasksList.appendChild(li);
          });
        });

        onSnapshot(collection(db, "messages"), (snap) => {
          messagesDiv.innerHTML = "";
          snap.forEach(doc => {
            const m = doc.data();
            const div = document.createElement("div");
            const hash = [...m.uid].reduce((a, b) => a + b.charCodeAt(0), 0) % 4;
            div.className = `message-bubble user-${hash}`;
            div.textContent = `${m.name}: ${m.text}`;
            messagesDiv.appendChild(div);
          });
        });

        sendBtn.onclick = async () => {
          if (messageInput.value.trim() !== "") {
            await addDoc(collection(db, "messages"), {
              uid: user.uid,
              name: data.name,
              text: messageInput.value,
              timestamp: serverTimestamp()
            });
            messageInput.value = "";
          }
        };
      } else {
        loginSection.style.display = "block";
        dashboard.style.display = "none";
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WoofWorks Dashboard</title>
  <style>
    :root {
      --bg: #0b0f0c;
      --panel: #111c14;
      --accent: #00ff88;
      --text: #d8ffe4;
      --accent-soft: #00cc77;
      --msg-0: #1a3d2b;
      --msg-1: #2e5f47;
      --msg-2: #3a805c;
      --msg-3: #4ebf88;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: var(--panel);
      padding: 1rem 2rem;
      font-size: 2rem;
      color: var(--accent);
      text-shadow: 0 0 10px var(--accent);
    }
    main {
      flex: 1;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    section {
      background: var(--panel);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1rem;
      width: 95%;
      max-width: 800px;
      box-shadow: 0 0 15px var(--accent-soft);
    }
    h2 {
      margin-top: 0;
      color: var(--accent);
    }
    input, textarea, button {
      background: #0f1813;
      border: 1px solid var(--accent);
      color: var(--text);
      border-radius: 8px;
      padding: 0.7rem;
      margin: 0.4rem 0;
      font-size: 1rem;
      width: 100%;
    }
    button {
      background: var(--accent);
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    #chat-messages .message {
      padding: 0.5rem;
      border-radius: 10px;
      margin: 0.3rem 0;
      max-width: 80%;
      word-wrap: break-word;
    }
    .user-0 { background: var(--msg-0); }
    .user-1 { background: var(--msg-1); }
    .user-2 { background: var(--msg-2); }
    .user-3 { background: var(--msg-3); }
    #admin-tab { display: none; }
  </style>
</head>
<body>
  <header>üêæ WoofWorks Dashboard</header>
  <main>
    <section id="login">
      <h2>Login</h2>
      <input id="email" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <button id="login-btn">Login</button>
      <p id="login-error" style="color:#ff8080;"></p>
    </section>

    <section id="dashboard" style="display:none;">
      <h2>Your Info</h2>
      <p><strong>WoofCoin:</strong> <span id="woofcoin"></span></p>
      <p><strong>Rank:</strong> <span id="rank"></span></p>
      <p><strong>Role:</strong> <span id="role"></span></p>
      <p><strong>Admin:</strong> <span id="admin"></span></p>
      <button id="logout-btn">Logout</button>
    </section>

    <section id="tasks" style="display:none;">
      <h2>Public Tasks</h2>
      <ul id="tasks-list"></ul>
    </section>

    <section id="chat" style="display:none;">
      <h2>Team Chat</h2>
      <div id="chat-messages"></div>
      <textarea id="chat-input" placeholder="Type a message..."></textarea>
      <button id="send-btn">Send</button>
    </section>

    <section id="admin-tab">
      <h2>Admin Panel</h2>
      <div id="admin-users">Loading...</div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDsFimFgQKXLhpflX4PTfWcpKwfI5qM8I4",
      authDomain: "woofworks-dashboard.firebaseapp.com",
      projectId: "woofworks-dashboard",
      storageBucket: "woofworks-dashboard.firebasestorage.app",
      messagingSenderId: "150822066679",
      appId: "1:150822066679:web:4b5927a5389d90daa036f2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const emailInput = document.getElementById('email');
    const passInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const loginError = document.getElementById('login-error');

    const loginSection = document.getElementById('login');
    const dashSection = document.getElementById('dashboard');
    const tasksSection = document.getElementById('tasks');
    const chatSection = document.getElementById('chat');
    const adminTab = document.getElementById('admin-tab');

    const logoutBtn = document.getElementById('logout-btn');
    const woofcoin = document.getElementById('woofcoin');
    const rank = document.getElementById('rank');
    const role = document.getElementById('role');
    const isAdmin = document.getElementById('admin');
    const tasksList = document.getElementById('tasks-list');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const chatMessages = document.getElementById('chat-messages');
    const adminUsers = document.getElementById('admin-users');

    loginBtn.onclick = async () => {
      try {
        const userCred = await signInWithEmailAndPassword(auth, emailInput.value, passInput.value);
        const uid = userCred.user.uid;
        const userRef = doc(db, 'users', uid);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) {
          await setDoc(userRef, {
            woofcoin: 100,
            rank: "Intern",
            role: "Newbie",
            isAdmin: false,
            name: emailInput.value.split("@")[0]
          });
        }
      } catch (e) {
        loginError.textContent = e.message;
      }
    };

    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        loginSection.style.display = 'block';
        dashSection.style.display = 'none';
        tasksSection.style.display = 'none';
        chatSection.style.display = 'none';
        return;
      }

      loginSection.style.display = 'none';
      dashSection.style.display = 'block';
      tasksSection.style.display = 'block';
      chatSection.style.display = 'block';

      const uid = user.uid;
      const userRef = doc(db, 'users', uid);
      const snap = await getDoc(userRef);
      const data = snap.data();

      woofcoin.textContent = data.woofcoin;
      rank.textContent = data.rank;
      role.textContent = data.role;
      isAdmin.textContent = data.isAdmin ? "‚úÖ Yes" : "‚ùå No";

      if (data.isAdmin) {
        adminTab.style.display = 'block';
        const usersSnap = await getDocs(collection(db, 'users'));
        adminUsers.innerHTML = '';
        usersSnap.forEach(userDoc => {
          const u = userDoc.data();
          adminUsers.innerHTML += `
            <div style="margin-bottom:1rem;">
              <strong>${u.name}</strong><br>
              <label>WoofCoin: <input value="${u.woofcoin}" data-uid="${userDoc.id}" data-field="woofcoin"></label><br>
              <label>Rank: <input value="${u.rank}" data-uid="${userDoc.id}" data-field="rank"></label><br>
              <label>Role: <input value="${u.role}" data-uid="${userDoc.id}" data-field="role"></label>
              <hr>
            </div>`;
        });

        adminUsers.onchange = async (e) => {
          const field = e.target.dataset.field;
          const uid = e.target.dataset.uid;
          const val = field === "woofcoin" ? parseInt(e.target.value) : e.target.value;
          await setDoc(doc(db, "users", uid), { [field]: val }, { merge: true });
        }
      }

      onSnapshot(collection(db, 'tasks'), snap => {
        tasksList.innerHTML = '';
        snap.forEach(doc => {
          tasksList.innerHTML += `<li>${doc.data().title}</li>`;
        });
      });

      onSnapshot(collection(db, 'messages'), snap => {
        chatMessages.innerHTML = '';
        snap.forEach(doc => {
          const m = doc.data();
          const hash = [...m.uid].reduce((a, b) => a + b.charCodeAt(0), 0) % 4;
          chatMessages.innerHTML += `<div class="message user-${hash}"><strong>${m.name}</strong>: ${m.text}</div>`;
        });
      });

      sendBtn.onclick = async () => {
        const msg = chatInput.value.trim();
        if (!msg) return;
        await addDoc(collection(db, 'messages'), {
          uid: user.uid,
          name: data.name,
          text: msg,
          timestamp: serverTimestamp()
        });
        chatInput.value = "";
      }
    });
  </script>
</body>
</html>
